<!DOCTYPE html>
<html>
<head>
  <title>Cost of air pollution</title>
  <script src="http://d3js.org/d3.v3.min.js"></script>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <style>
    body { color: #444; background: #fff; font: normal 12px "HelveticaNeueLT", Helvetica, Arial, sans-serif; margin: 2em; }
    header { margin: 0 0 20px 20px; border-bottom: 1px solid #6c6c6c; width: 270px; position: relative; }
    h1 { font-size: 14px; font-weight: normal; text-shadow: #fff 0 1px 0; margin: 0 0 0 0; padding: 0; }
    h2 { font-size: 12px; font-weight: normal; font-style: italic; text-shadow: #fff 0 1px 0; margin: 0 0 0 0; padding: 0; }
    small { margin: 0 0 10px 120px; color: #444; font-size: 12px; font-style: italic; top: 0.6em; position: top;}
    a { color: #a3a3a3; }

    text.label { fill: #444; }
    text.label.start { text-anchor: end; }
    line.slope1 {stroke: rgb(112,113,115); stroke-width: 1; }
    line.slope2 {stroke: rgb(163,191,51); stroke-width: 1; }

    .missing text.label { display: none; }
    .missing line.slope { display: none; }

    .over text.label { fill: rgb(70,111,169); font-size: 10px !important; font-weight: bold; }
    .over line.slope1 { stroke: rgb(70,111,169); stroke-width: 2; }
    .over line.slope2 { stroke: rgb(70,111,169); stroke-width: 2; }

    #textToDisplay{ color: #777 ; font-size: 12px !important; font-weight: normal; }
    .row {

      width: 500px;
      margin-left: -20px;
      *zoom: 1;
    }
    .row:before, .row:after {
      display: table;
      content: "";
    }
    .row:after {
      clear: both;
    }
    [class*="span"] {
      float: left;
      margin-left: 10px;
    }
    .span1 {
      width: 320px;
    }
    .span2  {
      width: 130px;
      word-wrap: break-word;
    }
    .span3, .container  {
      width: 450px;
    }

    .container {
      width: 450px;
      margin-left: auto;
      margin-right: auto;
      *zoom: 1;
    }
    .container:before, .container:after {
      display: table;
      content: "";
    }
    .container:after {
      clear: both;
    }
    .container-fluid {
      padding-left: 10px;
      padding-right: 10px;
      *zoom: 1;
    }
    .container-fluid:before, .container-fluid:after {
      display: table;
      content: "";
    }
    .container-fluid:after {
      clear: both;
    }
    #tooltip {
      position: absolute;
      width: auto;
      height: auto;
      padding: 10px;
      background-color: white;
      -webkit-border-radius: 2px;
      -moz-border-radius: 2px;
      border-radius: 2px;
      -webkit-box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.4);
      -moz-box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.4);
      box-shadow: 2px 2px 4px rgba(0, 0, 0, 0.4);
      pointer-events: none;
    }

#tooltip.hidden {
      display: none;
    }

#tooltip p {
      margin: 0;
      font-family: sans-serif;
      font-size: 10px;
      line-height: 12px;
    }
  </style>
</head>
<body>
  <div id="tooltip" class="hidden">
    <p>Country: <strong><span id="countryTooltip">All</span></strong></p>
    <p>2005: <i><span id="startTooltip">XX</span></i></p>
    <p>2010: <i><span id="endTooltip">XX</span></i></p>
</div>
  <div class="row">
  <div class="span3">
  <header>
    <h1>
      Cost of deaths from ambient air pollution
    </h1><p>
  </header>
</div></div>
  <div class="row">
  <div class="span3">
    <form >
      <label><input type="radio" name="mode" id="deathData" value="deathData" checked>  Number of death</label>
      <label><input type="radio" name="mode" id="vslData" value="vslData" >  VSL</label>
      <label><input type="radio" name="mode" id="costOfLifeData" value="costOfLifeData" >  Cost of deaths from ambient air</label>
    </form>
    <br>
    <small id="unitToDisplay">
      Number
    </small>
  </div >
  </div>

  <div class="row">
  <div class="span1" id="chart"></div>
  <div class="span2" id="textToDisplay"><br><p>Over the 5-year period from 2005 to 2010, there was an overall increase of about 4% in the number of premature deaths due to outdoor air pollution globally - with a 4% improvement in the OECD world being offset by a larger deterioration in the rest of the world:</p><p> while 20 of 34 OECD countries achieved progress, 14 did not.</p><p>The number of deaths due to outdoor air pollution in China rose to 12% of premature deaths; years of life lost increased by about 0.5%. Although the number of deaths in India is only just over half the number in China, the trend in India is increasing faster.</p></div>
</div>
</body>

<script>
  data = null;

  d3.csv("data/deathData.csv", function(csv) {
    data = csv;
    var
        // Extract years from the dataset
        years = d3.keys(csv[0]).filter( function(d) { return d.match(/^\d/) }); // Return numerical keys

        // Extract names of countries from the dataset
        countries = csv.map( function(d) { return d["Country"] }),
        // Set "from" and "to" years to display
        //from = d3.first(years),
        from = d3.min(years),
        to = d3.max(years),
        // Extract country names and start/end values from the dataset
        data = csv
                      .map( function(d) {
                        var r = {
                          label: d["Country"],
                          start: parseFloat(d[from]),
                          end: parseFloat(d[to])
                        };
                        
                        
                        return r;
                      })
                      //Require countries to have both values present
                      .filter(function(d) { return (!isNaN(d.start) && !isNaN(d.end)); }),
        // Extract the values for every country for both years in the dataset for the scale
        values = data
                      .map( function(d) { return parseFloat(d3.round(d.start, 2)); })
                      .filter( function(d) { return d; } )
                      .concat(
                        data
                          .map( function(d) { return parseFloat(d3.round(d.end, 2)); } )
                          .filter( function(d) { return d; } )
                      ),
        values=values.sort(function(a,b){return d3.descending(a,b);}),
        // Return true for countries without start/end values
        missing = function(d) { return !d.start || !d.end; },

        // Format values for labels
        label_format = function(value) { return d3.format("g")(d3.round(value, 2)); },

        font_size = 9,
        margin = 30,
        width = 300,
        height = countries.length * font_size*1.5,
        // height = 3000,

        chart = d3.select("#chart").append("svg")
                   .attr("width", width)
                   .attr("height", height+ 1.1 * font_size * countries.length);

//Ignore this code ... makes bl.ocks.org show this in an acceptable-sized iframe.
//var styleElement = parent.document.getElementById('styles_js'); if (!styleElement) {styleElement = parent.document.createElement('style'); styleElement.type = 'text/css'; styleElement.id = 'styles_js'; parent.document.getElementsByTagName('head')[0].appendChild(styleElement); } styleElement.appendChild(document.createTextNode('iframe{height:'+height+'px;}'));

    // Scales and positioning
    var slope = d3.scale.ordinal()
                  .domain(values)
                  .rangePoints([margin, height-5*margin]);

	//Go through the list of countries in order, adding additional space as necessary.
	var min_h_spacing = 1.1 * font_size, // 1.2 is standard font height:line space ratio
		previousY = 0,
		thisY,
		additionalSpacing;
	//Preset the Y positions (necessary only for the lower side)
	//These are used as suggested positions.
	data.forEach(function(d) {
		d.startY = slope(d3.round(d.start,2));
		d.endY = slope(d3.round(d.end,2));
	});

	//Loop over the higher side (right) values, adding space to both sides if there's a collision
	data
		.sort(function(a,b) {
			if (a.end == b.end) return 0;
			return (a.end < b.end) ? -3 : +3;
		})
		.forEach(function(d) {
			thisY = d.endY; //position "suggestion"
			additionalSpacing = d3.max([0, d3.min([(min_h_spacing - (thisY - previousY)), min_h_spacing])]);
	
			//Adjust all Y positions lower than this end's original Y position by the delta offset to preserve slopes:
			data.forEach(function(dd) {
				if (dd.startY >= d.endY) dd.startY += additionalSpacing;
				if (dd.endY >= d.endY) dd.endY += additionalSpacing;
			});
		
			previousY = thisY;
		});

	//Loop over the lower side (left) values, adding space to both sides if there's a collision
	previousY = 0;
	data
		.sort(function(a,b) {
			if (a.startY == b.startY) return 0;
			return (a.startY < b.startY) ? -1 : +1;
		})
		.forEach(function(d) {
			thisY = d.startY; //position "suggestion"
			additionalSpacing = d3.max([0, d3.min([(min_h_spacing - (thisY - previousY)), min_h_spacing])]);
	
			//Adjust all Y positions lower than this start's original Y position by the delta offset to preserve slopes:
			data.forEach(function(dd) {
				if (dd.endY >= d.startY) dd.endY += additionalSpacing;
				if (dd.label != d.label && dd.startY >= d.startY) dd.startY += additionalSpacing;
			});
			previousY = thisY;
		});

    // Countries
    var country = chart.selectAll("g.country")
                    .data( data )
                    .enter()
                    .append("g")
                    .attr("class", "country")
                    .classed("missing", function(d) { return missing(d); });

    country
      .on("mouseover", function(d,i) { return d3.select(this).classed("over", true); })
      .on("mouseout", function(d,i) { return d3.select(this).classed("over", false); });

    // ** Left column
    country
      .append("text")
      .classed("label start", true)
      .attr("x", 100)
      .attr("y", function(d) {return d.startY;})
      //.attr("y", function(d,i) { var rounded = d3.round(d.start, 1); return slope(rounded) })
      .attr("xml:space", "preserve")
      .style("font-size", font_size)
      .text(function(d) { return d.label+ " " + label_format(d.start);});

    // ** Right column
    country
      .append("text")
      .classed("label end", true)
      .attr("x", width-100)
      .attr("y", function(d) {return d.endY;})
      //.attr("y", function(d,i) { var rounded = d3.round(d.end, 1); return slope(rounded) })
      .attr("xml:space", "preserve")
      .style("font-size", font_size)
      .text(function(d) { return label_format(d.end) + " " + d.label;  });

    // ** Slope lines
    country
      .append("line")
      .classed("slope1", function(d) { if (d.start>d.end) return d.start || d.end; })
      .classed("slope2", function(d) { if (d.start<=d.end)return d.start || d.end; })
      .attr("x1", 110)
      .attr("x2", width-110)
      .attr("y1", function(d,i) {
        return d.start && d.end ? d.startY - font_size/2 + 2 : null;
      })
      .attr("y2", function(d,i) {
        return d.end && d.end ? d.endY - font_size/2 + 2 : null;
      });

    chart
      .append("text")
      .classed("label start", true)
      .attr("x", 100)
      .attr("y", 22)
      //.attr("y", function(d,i) { var rounded = d3.round(d.start, 1); return slope(rounded) })
      .attr("xml:space", "preserve")
      //.style("font-size", font_size)
      .style("font-weight","bold")
      .text("2005");

    chart
      .append("text")
      .classed("label start", true)
      .attr("x", width-75)
      .attr("y", 22)
      //.attr("y", function(d,i) { var rounded = d3.round(d.start, 1); return slope(rounded) })
      .attr("xml:space", "preserve")
      //.style("font-size", font_size)
      .style("font-weight","bold")
      .text("2010");

    chart.selectAll("text")
      .on("mouseover",function(d){
        var xPosition = parseFloat(d3.select(this).attr("x")) + document.getElementById("chart").offsetLeft + 1.5*margin.left ;
        var yPosition = parseFloat(d3.select(this).attr("y")) +document.getElementById("chart").offsetTop - font_size*1.5;
                 
        d3.select("#tooltip")
                    .style("left",width+"px")
                    .style("top", yPosition+"px") 
                    .select("#countryTooltip")
                    .text(function(){
                        return d.label;
                    });
        d3.select("#tooltip")
                    .select("#startTooltip")
                    .text(function(){
                        return d.start + " deaths";
                    });
        d3.select("#tooltip") 
                    .select("#endTooltip")
                    .text(function(){
                        return d.end + " deaths";
                    });
        d3.select("#tooltip").classed("hidden", false);
      })
      .on("mouseout",function(d){
          d3.select("#tooltip").classed("hidden", true);
      });

    return chart;
  });

        d3.selectAll("input").on("change", change);

function change(){

    var radios = document.getElementsByName('mode');
    var URL;

    for (var i = 0, length = radios.length; i < length; i++) {
        if (radios[i].checked) {
            URL="data/"+radios[i].value+".csv";
          if(radios[i].value=="deathData"){
                      document.getElementById("unitToDisplay").innerHTML = "Number";
                      document.getElementById("textToDisplay").innerHTML = "<br><p>Over the 5-year period from 2005 to 2010, there was an overall increase of about 4% in the number of premature deaths due to outdoor air pollution globally - with a 4% improvement in the OECD world being offset by a larger deterioration in the rest of the world:</p><p> while 20 of 34 OECD countries achieved progress, 14 did not.</p><p>The number of deaths due to outdoor air pollution in China rose to 12% of premature deaths; years of life lost increased by about 0.5%. Although the number of deaths in India is only just over half the number in China, the trend in India is increasing faster.</p>";
          }
          if(radios[i].value=="vslData"){
                      document.getElementById("unitToDisplay").innerHTML = "in USD millions";
                      document.getElementById("textToDisplay").innerHTML = "<br><p>VSL= Value of a Statistical Life</p><p>In the case of the ultimate impact on health - mortality - economics today possesses a singular, and singularly elegant, <i>standard methodw</i> by which to measure the cost of this impact from a given source: that is to say, to measure the loss of the valued item - life - at the level of the society as a whole. This is the Value of a Statistical Life (VSL).";
          }
          if(radios[i].value=="costOfLifeData"){
                      document.getElementById("unitToDisplay").innerHTML = "in USD millions";
                      document.getElementById("textToDisplay").innerHTML = "<br><p>Outdoor air pollution kills more than three million people across the world every year, and causes health problems from asthma to heart disease for many more.</p><p>This is costing OECD societies plus China and India an estimated 3.5 trillion dollars a year in value of lives lost and ill health, and the trend is rising.</p><p>But how much of the cost of those deaths and health problems is due to pollution from cars, trucks and motorcycles on our roads? Initial evidence based on new information and methods of calculation suggests that road transport is likely responsible for about half the total of USD 1.7 trillion for OECD countries:</p><p>Almost USD 1 trillion.</p>";    
          }
            break;
        }
    }

  d3.select("svg")
  .remove();

  d3.csv(URL, function(csv) {
    data = csv;
    var
        // Extract years from the dataset
        years = d3.keys(csv[0]).filter( function(d) { return d.match(/^\d/) }); // Return numerical keys

        // Extract names of countries from the dataset
        countries = csv.map( function(d) { return d["Country"] }),
        // Set "from" and "to" years to display
        //from = d3.first(years),
        from = d3.min(years),
        to = d3.max(years),
        // Extract country names and start/end values from the dataset
        data = csv
                      .map( function(d) {
                        var r = {
                          label: d["Country"],
                          start: parseFloat(d[from]),
                          end: parseFloat(d[to])
                        };
                        
                        
                        return r;
                      })
                      //Require countries to have both values present
                      .filter(function(d) { return (!isNaN(d.start) && !isNaN(d.end)); }),
        // Extract the values for every country for both years in the dataset for the scale
        values = data
                      .map( function(d) { return parseFloat(d3.round(d.start, 2)); })
                      .filter( function(d) { return d; } )
                      .concat(
                        data
                          .map( function(d) { return parseFloat(d3.round(d.end, 2)); } )
                          .filter( function(d) { return d; } )
                      ),
        values=values.sort(function(a,b){return d3.descending(a,b);}),
        // Return true for countries without start/end values
        missing = function(d) { return !d.start || !d.end; },

        // Format values for labels
        label_format = function(value) { return d3.format("g")(d3.round(value, 2)); },

        font_size = 9,
        margin = 30,
        width = 300,
        height = countries.length * font_size*1.5;
        // height = 3000,

        chart = d3.select("#chart").append("svg")
                   .attr("width", width)
                   .attr("height", height+ 1.1 * font_size * countries.length);

//Ignore this code ... makes bl.ocks.org show this in an acceptable-sized iframe.
//var styleElement = parent.document.getElementById('styles_js'); if (!styleElement) {styleElement = parent.document.createElement('style'); styleElement.type = 'text/css'; styleElement.id = 'styles_js'; parent.document.getElementsByTagName('head')[0].appendChild(styleElement); } styleElement.appendChild(document.createTextNode('iframe{height:'+height+'px;}'));

    // Scales and positioning
    var slope = d3.scale.ordinal()
                  .domain(values)
                  .rangePoints([margin, height-5*margin]);

  //Go through the list of countries in order, adding additional space as necessary.
  var min_h_spacing = 1.1 * font_size, // 1.2 is standard font height:line space ratio
    previousY = 0,
    thisY,
    additionalSpacing;
  //Preset the Y positions (necessary only for the lower side)
  //These are used as suggested positions.
  data.forEach(function(d) {
    d.startY = slope(d3.round(d.start,2));
    d.endY = slope(d3.round(d.end,2));
  });

  //Loop over the higher side (right) values, adding space to both sides if there's a collision
  data
    .sort(function(a,b) {
      if (a.end == b.end) return 0;
      return (a.end < b.end) ? -3 : +3;
    })
    .forEach(function(d) {
      thisY = d.endY; //position "suggestion"
      additionalSpacing = d3.max([0, d3.min([(min_h_spacing - (thisY - previousY)), min_h_spacing])]);
  
      //Adjust all Y positions lower than this end's original Y position by the delta offset to preserve slopes:
      data.forEach(function(dd) {
        if (dd.startY >= d.endY) dd.startY += additionalSpacing;
        if (dd.endY >= d.endY) dd.endY += additionalSpacing;
      });
    
      previousY = thisY;
    });

  //Loop over the lower side (left) values, adding space to both sides if there's a collision
  previousY = 0;
  data
    .sort(function(a,b) {
      if (a.startY == b.startY) return 0;
      return (a.startY < b.startY) ? -1 : +1;
    })
    .forEach(function(d) {
      thisY = d.startY; //position "suggestion"
      additionalSpacing = d3.max([0, d3.min([(min_h_spacing - (thisY - previousY)), min_h_spacing])]);
  
      //Adjust all Y positions lower than this start's original Y position by the delta offset to preserve slopes:
      data.forEach(function(dd) {
        if (dd.endY >= d.startY) dd.endY += additionalSpacing;
        if (dd.label != d.label && dd.startY >= d.startY) dd.startY += additionalSpacing;
      });
      previousY = thisY;
    });

    // Countries
    var country = chart.selectAll("g.country")
                    .data( data )
                    .enter()
                    .append("g")
                    .attr("class", "country")
                    .classed("missing", function(d) { return missing(d); });

    country
      .on("mouseover", function(d,i) {return d3.select(this).classed("over", true); })
      .on("mouseout", function(d,i) { return d3.select(this).classed("over", false); });

    // ** Left column
    country
      .append("text")
      .classed("label start", true)
      .attr("x", 100)
      .attr("y", function(d) {return d.startY;})
      //.attr("y", function(d,i) { var rounded = d3.round(d.start, 1); return slope(rounded) })
      .attr("xml:space", "preserve")
      .style("font-size", font_size)
      .text(function(d) { return d.label+ " " + label_format(d.start);});

    // ** Right column
    country
      .append("text")
      .classed("label end", true)
      .attr("x", width-100)
      .attr("y", function(d) {return d.endY;})
      //.attr("y", function(d,i) { var rounded = d3.round(d.end, 1); return slope(rounded) })
      .attr("xml:space", "preserve")
      .style("font-size", font_size)
      .text(function(d) { return label_format(d.end) + " " + d.label;  });

    // ** Slope lines
    country
      .append("line")
      .classed("slope1", function(d) { if (d.start>d.end) return d.start || d.end; })
      .classed("slope2", function(d) { if (d.start<=d.end)return d.start || d.end; })
      .attr("x1", 110)
      .attr("x2", width-110)
      .attr("y1", function(d,i) {
        return d.start && d.end ? d.startY - font_size/2 + 2 : null;
      })
      .attr("y2", function(d,i) {
        return d.end && d.end ? d.endY - font_size/2 + 2 : null;
      });

    chart
      .append("text")
      .classed("label start", true)
      .attr("x", 100)
      .attr("y", 22)
      //.attr("y", function(d,i) { var rounded = d3.round(d.start, 1); return slope(rounded) })
      .attr("xml:space", "preserve")
      //.style("font-size", font_size)
      .style("font-weight","bold")
      .text("2005");

    chart
      .append("text")
      .classed("label start", true)
      .attr("x", width-75)
      .attr("y", 22)
      //.attr("y", function(d,i) { var rounded = d3.round(d.start, 1); return slope(rounded) })
      .attr("xml:space", "preserve")
      //.style("font-size", font_size)
      .style("font-weight","bold")
      .text("2010");
    chart.selectAll("text")
      .on("mouseover",function(d){
        var xPosition = parseFloat(d3.select(this).attr("x")) + document.getElementById("chart").offsetLeft + 1.5*margin.left ;
        var yPosition = parseFloat(d3.select(this).attr("y")) +document.getElementById("chart").offsetTop - font_size*1.5;
                 
        d3.select("#tooltip")
                    .style("left",width+"px")
                    .style("top", yPosition+"px") 
                    .select("#countryTooltip")
                    .text(function(){
                        return d.label;
                    });
        d3.select("#tooltip")
                    .select("#startTooltip")
                    .text(function(){
                      if(document.getElementById("unitToDisplay").innerHTML=="Number")
                        return d.start + " deaths";
                      else  
                        return d.start + " USD millions";
                    });
        d3.select("#tooltip") 
                    .select("#endTooltip")
                    .text(function(){
                      if(document.getElementById("unitToDisplay").innerHTML=="Number")
                        return d.end + " deaths";
                      else  
                        return d.end + " USD millions";
                    });
        d3.select("#tooltip").classed("hidden", false);
      })
      .on("mouseout",function(d){
          d3.select("#tooltip").classed("hidden", true);
      });

    return chart;
  });
};
</script>

</html>
